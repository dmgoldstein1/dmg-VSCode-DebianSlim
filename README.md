
# VS Code Server Debian Container

<!-- Generated by Copilot (GPT-4), 2025-08-29 -->
<!-- This README documents the VS Code Server Docker container build script and its features. -->
<!-- It provides comprehensive usage instructions for secure, containerized VS Code development environments. -->

A secure, containerized VS Code Server environment built on Debian Slim with automated vulnerability analysis, GitHub tunnel support, and non-interactive GitHub CLI authentication.

## Features

- **Secure Base Image**: Built on Debian Stable Slim with minimal attack surface
- **Automated Security Scanning**: Docker Scout vulnerability analysis with intelligent caching
- **GitHub Tunnel Integration**: Seamless remote access via GitHub tunnels
- **GitHub CLI Auto-Auth**: If `GH_TOKEN`/`GITHUB_TOKEN` is set, container authenticates `gh` and configures git
- **VS Code CLI Updates**: Auto-update at startup (if available), hourly checks thereafter with user-approved upgrades
- **Port Conflict Resolution**: Automatic port detection and assignment
- **Intelligent Redundancy Reduction**: Skips unnecessary rebuilds and analysis
- **Flexible Logging**: Quiet by default, verbose when needed
- **Autonomous Copilot Support**: Optional auto-approval for terminal commands
- **YAML-Driven Configuration**: Supply options via a single build_variables.yaml file

## Quick Start

### Basic Usage

```bash
# Build and launch with auto-generated tunnel name
./build_vscode_docker_debian_slim_secure.sh

# Build and launch with custom tunnel name
./build_vscode_docker_debian_slim_secure.sh my_dev_tunnel
```

### Advanced Usage

```bash
# Enable verbose logging for debugging
./build_vscode_docker_debian_slim_secure.sh my_tunnel --logging

# Force security analysis even if cached
./build_vscode_docker_debian_slim_secure.sh my_tunnel --force-analysis

# Enable autonomous Copilot terminal commands
./build_vscode_docker_debian_slim_secure.sh my_tunnel --copilot-is-autonomous

# Combine multiple flags
./build_vscode_docker_debian_slim_secure.sh my_tunnel --logging --copilot-is-autonomous
```

## Command Line Options

| Flag | Description |
|------|-------------|
| `[TunnelName]` | Optional custom tunnel name (lowercase letters, numbers, underscores only) |
| `--logging` | Enable verbose output for debugging and detailed progress information |
| `--force-analysis` | Force Docker Scout analysis even if cached results exist |
| `--copilot-is-autonomous` | Configure VS Code to auto-approve terminal commands for GitHub Copilot |
| `--git-user-name NAME` | Set git user.name inside the container (env GIT_USER_NAME) |
| `--git-user-email EMAIL` | Set git user.email inside the container (env GIT_USER_EMAIL) |
| `--gh-token TOKEN` | Provide a GitHub token for non-interactive gh auth (env GH_TOKEN) |
| `--auto-update-on-start true\|false` | Control VS Code CLI auto-update at startup |
| `--update-check-interval-seconds N` | Seconds between mid-run update checks |
| `--approval-file PATH` | Path to approval file for mid-run updates |
| `--use-yaml` | Ignore all CLI flags/args and load settings from build_variables.yaml |

## YAML mode (build_variables.yaml)

Avoid long command lines by placing configuration in `build_variables.yaml` at the repo root, then running the script with `--use-yaml`.

- Location: `./build_variables.yaml`
- Run: `./build_vscode_docker_debian_slim_secure.sh --use-yaml`
- Behavior: When `--use-yaml` is present, the script ignores all other CLI flags/args.
- Security: Keep secrets (like `gh_token`) out of version control. The file includes commented examples you can uncomment locally.

### Supported keys and their default values

| Key                        | Type    | Default Value                        | Description                                      |
|----------------------------|---------|--------------------------------------|--------------------------------------------------|
| `tunnel_name`              | string  | ""                                   | Optional tunnel/container name (auto-generated if empty) |
| `force_analysis`           | bool    | false                                | Force re-run of Docker Scout analysis            |
| `logging`                  | bool    | false                                | Verbose logging for this build script            |
| `copilot_is_autonomous`    | bool    | false                                | Enable autonomous Copilot terminal approvals     |
| `git_user_name`            | string  | ""                                   | Git user.name inside the container               |
| `git_user_email`           | string  | ""                                   | Git user.email inside the container              |
| `gh_token`                 | string  | ""                                   | GitHub token for non-interactive `gh` login      |
| `auto_update_on_start`     | bool    | true                                 | Control CLI auto-update at startup               |
| `update_check_interval_seconds` | int | 3600                                 | Seconds between update checks                    |
| `approval_file`            | string  | `$HOME/APPROVE_CODE_UPDATE`          | Path inside the container for granting mid-run updates |

Tip: The repo already includes `build_variables.yaml` with commented example lines for each key and their defaults.

## Tunnel Name Validation

Tunnel names must follow these rules:

- Only lowercase letters (a-z)
- Numbers (0-9)
- Underscores (_)
- No capital letters, spaces, or special characters

**Valid Examples**: `my_tunnel`, `dev_env_2024`, `project_alpha`

**Invalid Examples**: `My-Tunnel`, `dev env`, `project@home`

## Security Features

### Automated Vulnerability Scanning

The script automatically runs Docker Scout analysis to identify:

- Critical, High, Medium, and Low severity vulnerabilities
- Package-specific security issues
- Recommended updates and fixes

### Intelligent Caching

- Skips redundant image builds when dependencies haven't changed
- Caches vulnerability analysis results by image tag
- Reduces build time for subsequent runs

### Non-Root Container Execution

- All VS Code processes run as `devuser` (non-root)
- Sudo access available when needed for development tasks

## Port Management

The script automatically handles port conflicts:

- Starts checking at port 8080
- Auto-increments to find available ports (8081, 8082, etc.)
- Supports multiple concurrent containers

## GitHub Tunnel Setup

1. Run the script with your desired tunnel name
2. Copy the authentication code from the output
3. Visit the provided GitHub device login URL
4. Enter the code to authorize the tunnel
5. Access your environment via `https://vscode.dev/tunnel/[tunnel-name]`

### Non-Interactive GitHub CLI Authentication

- If you set `GH_TOKEN` or `GITHUB_TOKEN` at container start, the entrypoint will:
        - Run `gh auth login --with-token` using the token from the environment
        - Run `gh auth setup-git` to configure git credential helper
- Optional (recommended): set `GIT_USER_NAME` and `GIT_USER_EMAIL` to configure git identity.

Environment variables:

- `GH_TOKEN` or `GITHUB_TOKEN` – GitHub token used to authenticate `gh` on startup.
- `GIT_USER_NAME` / `GIT_USER_EMAIL` – Configure global git identity.
- `TUNNEL_NAME` – Optional name for the VS Code tunnel.
- `VERBOSE` – `true` for verbose entrypoint logs (default `false`).

From the build script, you can provide these in two ways:

- CLI flags: `--gh-token`, `--git-user-name`, `--git-user-email` (forwarded as env vars into the container)
- YAML keys: `gh_token`, `git_user_name`, `git_user_email` (forwarded as env vars into the container)

### Configuring git identity inside the container

Set `GIT_USER_NAME` and `GIT_USER_EMAIL` as environment variables when starting the container. The entrypoint will run `git config --global user.name` and `git config --global user.email` accordingly, storing them in `/home/devuser/.gitconfig`.

```bash
# Generated by Copilot (GPT-4) — Example: pass git name/email at run
docker run -d --name vscode-tunnel \
    -e TUNNEL_NAME=my_tunnel \
    -e GH_TOKEN=ghp_your_token_here \
    -e GIT_USER_NAME="Jane Developer" \
    -e GIT_USER_EMAIL="jane.dev@example.com" \
    dmg-vscode:latest

# Verify inside the container
docker exec -it vscode-tunnel bash -lc 'git config --global --list | grep -E "^user\\."'
```

## Autonomous Copilot Mode

When using `--copilot-is-autonomous`, the container is configured to automatically approve terminal commands suggested by GitHub Copilot. This creates a VS Code server settings file at `/home/devuser/.vscode-server/data/Machine/settings.json` with:

```json
{
    "chat.tools.terminal.autoApprove": {
        "/.*/": true
    }
}
```

**⚠️ Security Warning**: Only use autonomous mode in trusted development environments. This setting allows Copilot to execute terminal commands without manual approval.

Build script integration:

- CLI flag: `--copilot-is-autonomous`
- YAML key: `copilot_is_autonomous: true`

## VS Code CLI Updates (Auto-Update + Hourly Checks)

The entrypoint manages updates for the VS Code CLI installed via Microsoft’s apt repo:

- On startup (default behavior):
        - Refreshes apt indexes and compares installed vs candidate `code` versions.
        - If an update is available, it installs it automatically.
        - Control via `AUTO_UPDATE_ON_START` (default `true`). Set to `false` to skip.

- While running (hourly by default):
        - Checks for an available update every `UPDATE_CHECK_INTERVAL_SECONDS` (default `3600`).
        - If an update is available, it logs a notification but does not upgrade automatically.
        - To approve an upgrade, create the file `$HOME/APPROVE_CODE_UPDATE` inside the container. The watcher will perform the upgrade and remove the file.

Config:

- `AUTO_UPDATE_ON_START` – `true`/`false`; auto-upgrade on container start (default `true`).
- `UPDATE_CHECK_INTERVAL_SECONDS` – seconds between checks (default `3600`).
- `APPROVAL_FILE` – path to approval file (default `$HOME/APPROVE_CODE_UPDATE`).

Build script integration:

- CLI flags: `--auto-update-on-start`, `--update-check-interval-seconds`, `--approval-file`
- YAML keys: `auto_update_on_start`, `update_check_interval_seconds`, `approval_file`

Notes:

- If `apt-get` is not available in the image, the entrypoint logs and skips update checks.
- All actions are logged to `~/LOGS/entrypoint-log-<UNIX_TIMESTAMP>.log`.

## File Structure

```text
├── Dockerfile                                  # Container definition (Debian Slim + official VS Code apt repo)
├── build_vscode_docker_debian_slim_secure.sh   # Main build and launch script
├── build_variables.yaml                         # YAML config consumed by the build script (commented examples)
├── scripts/
│   └── vscode-tunnel-entrypoint.sh             # Entrypoint: gh auto-auth + VS Code tunnel + update checks
└── README.md                                   # This documentation
```

## Logging and Debugging

All logs generated by the build script—including Docker build/run logs, security remediation, Docker Scout analysis, and verbose output—are saved in the `/logs` directory. If a log file with the same name already exists, an incrementing number is appended to avoid conflicts (e.g., `docker-build-abc123.log`, `docker-build-abc123_1.log`).

### Default (Quiet) Mode

Shows only essential information on the console. All background logs are still saved in `/logs`.

### Verbose Mode (`--logging`)

Provides detailed information, with all output also saved to a unique log file in `/logs` for later review.

## Dependencies

### System Requirements

- Docker (with Docker Scout enabled)
- `lsof` command for port detection
- `awk`/`gawk` for log processing
- Internet access to Microsoft and GitHub apt repos for updates

### Container Includes

- VS Code CLI/Server (from Microsoft apt repo)
- GitHub CLI
- Git
- Essential development tools
- Minimal base tools (curl, bash, coreutils)

## Troubleshooting

### Common Issues

#### Port Already in Use

- The script automatically finds available ports
- Check `docker ps` for existing containers

#### Tunnel Authentication Fails

- Ensure you're logged into GitHub
- Copy the exact authentication code provided
- Use the specific device login URL shown
- If using `GH_TOKEN`/`GITHUB_TOKEN`, verify the token scopes and that it’s passed at container start

#### Container Won't Start

- Check Docker daemon is running
- Verify image built successfully
- Use `--logging` flag for detailed error information
- Review `~/LOGS/entrypoint-log-*.log` for gh auth and update checks

### Getting Container Logs

```bash
# View container output
docker logs [container-name]

# Follow live logs
docker logs -f [container-name]
```

### Accessing Container Shell

```bash
# Get interactive shell
docker exec -it [container-name] bash
```

### Approving a Mid-Run VS Code CLI Update

```bash
# Create approval file to permit update on next hourly check
docker exec -it [container-name] bash -lc 'touch $HOME/APPROVE_CODE_UPDATE'
```

## Try it

```bash
# 1) Build the image (from the repo root)
docker build -t dmg-vscode:latest .

# 2) Run with a tunnel name and a GitHub token for non-interactive gh auth
#    Replace GH_TOKEN with a valid token (do not commit tokens)
docker run -d --name vscode-tunnel \
    -e TUNNEL_NAME=my_tunnel \
    -e GH_TOKEN=ghp_your_token_here \
    -e VERBOSE=true \
    dmg-vscode:latest

# 3) Watch logs to see tunnel URL and update checks
docker logs -f vscode-tunnel

# 4) Approve a mid-run VS Code CLI update when notified
docker exec -it vscode-tunnel bash -lc 'touch $HOME/APPROVE_CODE_UPDATE'
```

### Try it (YAML mode)

```bash
# Generated by Copilot (GPT-4) — Use YAML mode to avoid long command lines

# 1) Edit build_variables.yaml and uncomment keys you want (e.g., tunnel_name, gh_token, git_user_name/email)
#    Do NOT commit real secrets.

# 2) Build and launch via YAML mode
./build_vscode_docker_debian_slim_secure.sh --use-yaml

# 3) Watch logs
docker logs -f my_team_tunnel_01   # replace with your tunnel_name

# 4) Approve a mid-run VS Code CLI update when notified
docker exec -it my_team_tunnel_01 bash -lc 'touch $HOME/APPROVE_CODE_UPDATE'
```

## Performance Optimization

- **Image Caching**: Containers reuse existing images when possible
- **Analysis Caching**: Security scans cached by image tag
- **Background Execution**: Containers run in detached mode
- **Minimal Base**: Debian Slim reduces image size and attack surface

## Security Best Practices

1. **Regular Updates**: Rebuild containers periodically for security patches
2. **Tunnel Management**: Use descriptive tunnel names for identification
3. **Access Control**: Monitor tunnel access via GitHub settings
4. **Resource Limits**: Consider Docker resource constraints for production use
5. **Autonomous Mode**: Only enable Copilot autonomy in trusted environments
6. **Token Handling**: Pass `GH_TOKEN`/`GITHUB_TOKEN` as runtime env vars; never bake credentials into images

## Contributing

When modifying this script:

1. Maintain backward compatibility
2. Update this README for new features
3. Test with both `--logging` and quiet modes
4. Ensure security scanning continues to work
5. Follow the existing code style and comments

## License

This project follows standard Docker and VS Code licensing terms. See individual component licenses for details.
