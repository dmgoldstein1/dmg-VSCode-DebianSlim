<!--
Generated by Copilot (GPT-4o), 2025-09-12
This file was created by Copilot to document the CI/CD and security workflows for this repository, and how to replicate them locally using `act`.
-->

# CI/CD and Security Workflows Documentation

This document explains the purpose and structure of the GitHub Actions workflows in this repository:

- `.github/workflows/ci-cd.yml`
- `.github/workflows/security.yml`

It also provides instructions for running these workflows locally using [`act`](https://github.com/nektos/act).

---

## 1. CI/CD Workflow (`ci-cd.yml`)

**Purpose:**

- Automates linting, testing, building, security scanning, packaging, deployment, and cleanup for the VS Code Debian Slim Docker build system and extension.

**Main Jobs:**

- **Lint and Validate:** Lints TypeScript, shell scripts, and YAML files.
- **Unit Tests:** Runs TypeScript and shell unit tests, uploads logs.
- **Integration Tests:** Runs integration scripts, tests Docker builds and tunnel naming, uploads logs.
- **Docker Build and Test:** Builds and pushes multi-arch Docker images, tests image startup.
- **Security Scan:** Runs Trivy and Docker Scout vulnerability scans, uploads results to GitHub Security tab.
- **Extension Tests:** Compiles and packages the VS Code extension, uploads the artifact.
- **Deploy Release:** Creates a release and uploads the extension artifact (main branch only).
- **Cleanup:** Deletes old container images to save space.

**Triggers:**

- On push to `main`, `develop`, or tags starting with `v*`
- On pull requests to `main`
- Scheduled weekly security scans

---

## 2. Security Workflow (`security.yml`)

**Purpose:**

- Provides comprehensive security scanning and compliance checks for the codebase and containers.

**Main Jobs:**

- **SAST Scan:** Uses CodeQL for static analysis of JavaScript/TypeScript code.
- **Dependency Scan:** Runs `npm audit` and Snyk for dependency vulnerabilities.
- **Secret Scan:** Uses TruffleHog and custom grep to detect hardcoded secrets.
- **IaC Scan:** Uses Checkov to scan Dockerfiles and YAML for infrastructure security.
- **Container Security:** Builds containers and runs Dockle and container structure tests.
- **Security Report:** Aggregates results, generates a summary, and uploads as an artifact. Comments on PRs with a summary.

**Triggers:**

- On push to `main`, `develop`
- On pull requests to `main`
- Scheduled daily scans

---

## 3. Running Workflows Locally with `act`

[`act`](https://github.com/nektos/act) allows you to run GitHub Actions workflows locally for testing and debugging.

### Installation

- The repository includes a local `./bin/act` binary. You can also install via:

  ```bash
  curl -s https://raw.githubusercontent.com/nektos/act/master/install.sh | bash
  ```

### Usage

- To run a workflow locally:

  ```bash
  ./bin/act -W .github/workflows/ci-cd.yml
  ./bin/act -W .github/workflows/security.yml
  ```

- By default, `act` runs the `push` event. To run other events:

  ```bash
  ./bin/act pull_request -W .github/workflows/ci-cd.yml
  ./bin/act schedule -W .github/workflows/security.yml
  ```

### Required Secrets

Some jobs require secrets to run successfully. Pass them to `act` using `-s SECRET_NAME=VALUE` or via a `.secrets` file.

**Common secrets for these workflows:**

- `GITHUB_TOKEN` (required for Docker registry login, artifact upload, and security tab integration)
- `SNYK_TOKEN` (required for Snyk scans in `security.yml`)

**Example:**

```bash
./bin/act -W .github/workflows/security.yml -s GITHUB_TOKEN=ghp_xxx -s SNYK_TOKEN=xxx
```

Or create a `.secrets` file:

```plaintext
```plaintext
GITHUB_TOKEN=ghp_xxx
SNYK_TOKEN=xxx
```

And run:

```bash
./bin/act -W .github/workflows/security.yml --secret-file .secrets
```

### Additional Notes

- Some jobs use Docker-in-Docker (`docker:24-dind`). Ensure Docker is running and you have permissions.
- Some jobs require Node.js 18 and npm. Make sure these are installed locally.
- Not all GitHub Actions features are supported by `act`. If you encounter issues, check the [act documentation](https://github.com/nektos/act#usage).
- For scheduled events, use `act schedule ...`.

---

## 4. Troubleshooting

- If a job fails due to missing secrets, check the workflow for required secrets and provide them.
- For Docker-related jobs, ensure your user can run Docker commands.
- For security scans, ensure you have internet access to download scanners and dependencies.

---

## 5. References

- [ci-cd.yml](.github/workflows/ci-cd.yml)
- [security.yml](.github/workflows/security.yml)
- [act documentation](https://github.com/nektos/act)

---

*This documentation was generated by Copilot (GPT-4o) on 2025-09-12. Please update as workflows evolve.*
